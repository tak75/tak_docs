===
AWS
===

概要
====

* サービスの数は世界最大
* リソースが柔軟
* 従量課金で使用した分だけ支払えばよい
* マネジメントコンソール
  
  AWSログイン時に表示される画面のこと

初期設定
=========

* CloudWatchで料金アラートを設定

  * 請求ダッシュボードで請求アラートを受け取れるように設定
  
    * マネジメントコンソール画面のメニューバーのアカウントより、マイ請求ダッシュボードを選択
    * 左メニューから、Billing の設定を選択し各々設定する

  * CloudWatchで料金アラートを設定

    * CloudWatch->請求->アラームの作成
    * メトリクス->請求->概算合計請求額を選択し、チェックボックスにチェックを入れる
    * メトリクスの選択ボタンを押下
    * 閾値金額を入力（例：10USD）
    * 次へボタンを押下
    * トピック名とメアドを入力し、トピックの作成ボタンを押下
    * 次へボタンを押下
    * 名前と説明を入力し、次へボタンを押下
    * アラームの作成ボタンを押下
    * 上記メアドに通知メールがあるので、"Confirm subscription"ボタンを押下

* マネジメントコンソール画面のメニューバーのアカウントより、マイアカウント->IAMユーザーによる請求情報へのアクセス有効化で「有効」に設定
* IAMで作業ユーザを作成
* CloudTrailで操作ログを記録

  * デフォルトで有効になっているが、保存期間は90日のみ
  * S3に操作ログを保存することで、永久的に保存できる
  * ただし、CloudTrail自体は無料だが、S3の料金は必要

操作
====

* 操作ログ閲覧方法

  * サービス->CloudTrail->最近のイベント を閲覧する
  * デフォルト保存期間は90日

【VPC】ネットワーク構築
========================

----
用語
----

* リージョン

  * AWSの各サービスが提供されている地域のことであり、各国に存在する
  * 基本的には、最新サービスはまずアメリカリージョンで提供され、それから他のリージョンに展開される

* アベイラビリティゾーン

  * 独立したデータセンターのこと
  * リージョン内にはアベイラビリティゾーンが複数あり、災害等で1つが使用できなくなっても他で代替できる

* VPC
  
  * Virtual Private Cloud
  * AWS上に仮想ネットワークを作成できるサービス
  * IPv4 アドレスの範囲を CIDRブロックの形式で指定する必要がある (例: 10.0.0.0/16)。
  * プライベートIPアドレスを使用することが推奨されている

    * クラスA：10.0.0.0～10.255.255.255 （10.0.0.0/8）
    * クラスB：172.16.0.0～172.31.255.255 （172.16.0.0/12）
    * クラスC：192.168.0.0～192.168.255.255 （192.168.0.0/16）

  * VPC作成後はIPv4 アドレス範囲を変更できないので、大きめに設定する

    * 大きさは /28から/16で、/16が推奨

* サブネット
  
  * VPCを細かく区切ったネットワークであり、プライベート／パブリックの設定が可能
  * これにより、サブネットAは公開するが、サブネットBは非公開とする、ことでセキュリティを高める運用が可能
  * アベイラビリティゾーンを分けて配置することで、物理的な場所を離すことで、災害に強くなるメリットもある
  * IPv4 アドレス範囲は/24が標準的

* IPアドレスの表記

  * CIDR表記（サイダー）

    * Classless Inter-Domain Routing
    * 例：192.168.128.0/24
    * "/"の後の数値24は、ネットワーク部が先頭から24ビット目までであることを表す

  * サブネットマスク表記

    * 例：192.168.128.0/255.255.255.0

* ルートテーブル

  * VPCと各サブネットに対して設定できる
  * ルートテーブルに設定している送信先IPアドレス範囲（CIDRブロック）以外の通信は破棄される
  * "0.0.0.0/0"で、ルートテーブルに設定しているIPアドレス範囲以外のIPアドレスを意味する

----
手順
----

* VPCを作成する

  * テナンシー：デフォルト
  * VPCを作成すると、自動的にメインルートテーブルとメインネットワークACLが作成される？

* サブネットを作成する

  * パブリックサブネットを作成する
  * プライベートサブネットを作成する
  * VPCには、上記で作成したVPCを選択する
  * ルートテーブルとネットワークACLを明示的に設定しないと、VPCに設定されたメインルートテーブルとメインネットワークACLが利用される

* ルーティングを設定する

  * インターネットゲートウェイを作成し、VPCにアタッチする

    * 作成したIGWを選択し、アクション->VPCにアタッチを選択

  * ルートテーブルを作成し、パブリックサブネットに紐づける

    * 作成したルートテーブルを選択し、サブネットの関連付け->サブネットの関連付けの編集より、紐づけるサブネットを選択し保存する
    * 作成したルートテーブルを選択し、ルート->ルートの編集->ルートの追加より、以下のルートを追加する
    
      * 送信先："0.0.0.0/0"
      * ターゲット：Internet Gateway->作成したIGW

----
補足
----

* 異なるシステムの場合はアカウントを分けること
* 同一システムで本番環境とステージング環境を分けたい場合は、同一アカウントでVPCとリージョンを分けるのがオススメ

【EC2】Webサーバ構築
=====================

----
用語
----

* EC2

  * Elastic Compute Cloud
  * AWSクラウド上の仮想サーバ
  * 数分で起動し、1時間または秒単位で従量課金
  * 無料枠内でいくつEC2インスタンスを作成してもよいが、全インスタンスの稼働時間が750時間／月を超えると課金される

* AMI（アミイ）

  * Amazon Machine image
  * インスタンス起動に必要な情報が入ったOSのイメージ
  * サーバのテンプレートのようなもの
  * AWSやサードパーティがAMIを提供
  * カスタムAMIも作成可能
  * AMIから何台でもEC2インスタンスを起動可能

* インスタンスタイプ

  * サーバのスペックを定義したもの
  * インスタンスタイプにより、CPU、メモリ、ストレージ、ネットワーク帯域が異なる
  * 例：m5.xlarge

    * m
      
      * インスタンスファミリー
      * インスタンスの特徴を示す
      * 汎用的／CPU最適化／メモリ最適化／価格最適化／など

    * 5
    
      * インスタンス世代
      * 数値が大きいほど世代が新しい
      * 新しいものの方が性能／コストパフォーマンス／などがよい
      * 大きな数値を使用することが推奨

    * xlarge
    
      * インスタンスサイズ
      * CPU、メモリ、ネットワークのキャパシティを示す
      * small/large/xlarge/など

* ストレージ

  * サーバにくっつけるデータの保管場所
  * EC2には以下の2種類がある

    * EBS（Elastic Block Store）

      * 高い可能性と耐久性を持つストレージ
      * 他のインスタンスに付け替え可能
      * EBSの費用が別途発生
      * OSやDBなどの永続性と耐久性が必要なデータを置く

    * インスタンスストア

      * インスタンス専用の一時的なストレージ
      * 他のインスタンスに付け替えることはできない
      * 追加費用なし（無料）
      * 一時ファイル、キャッシュなど、失われても問題がないデータを置く

----
手順
----

* EC2インスタンスを設置する

  * AMIの選択

    * EC2->インスタンス->インスタンスの作成を選択する
    * クイックスタート->Amazon Linux 2 AMIを選択し選択ボタンを押下する

  * インスタンスタイプの選択

    * 無料枠で利用できる"t2.micro"を選択し次のステップボタンを押下する

  * インスタンス詳細の設定

    * インスタンス数：1
    * 購入のオプション：チェックなし（常時インスタンスを起動したいためスポットインスタンスではない）
    * ネットワーク：作成したVPCを選択
    * サブネット：作成したパブリックサブネットを選択
    * 自動割り当てパブリックIP：有効（インターネット経由でアクセスしたいため）
    * 配置グループ：チェックなし（複数インスタンスがある場合にインスタンス間のアクセスを高速化するために利用）
    * 

  * ストレージの追加
  * タグの追加
  * セキュリティグループの設定
  * SSHキーペアの設定

* Apacheをインストールする
* ファイアウォールを設定する

----
補足
----
