

<!doctype html>

<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AWS応用 &#8212; Tak Documents  ドキュメント</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script src="../../_static/translations.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="索引" href="../../genindex.html" />
    <link rel="search" title="検索" href="../../search.html" />
    <link rel="next" title="Cloud9" href="Cloud9.html" />
    <link rel="prev" title="AWS基礎" href="AWS%E5%9F%BA%E7%A4%8E.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             accesskey="I">索引</a></li>
        <li class="right" >
          <a href="Cloud9.html" title="Cloud9"
             accesskey="N">次へ</a> |</li>
        <li class="right" >
          <a href="AWS%E5%9F%BA%E7%A4%8E.html" title="AWS基礎"
             accesskey="P">前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Tak Documents  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Webアプリ</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">AWS</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">AWS応用</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="aws">
<h1>AWS応用<a class="headerlink" href="#aws" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="section" id="s3-cloudfront">
<h2>【S3/CloudFront】画像を配信する<a class="headerlink" href="#s3-cloudfront" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id1">
<h3>本項で構築するAWS環境<a class="headerlink" href="#id1" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="figure align-default" id="aws1-cloudfront">
<a class="reference internal image-reference" href="../../_images/AWS応用1_CloudFront.png"><img alt="../../_images/AWS応用1_CloudFront.png" src="../../_images/AWS応用1_CloudFront.png" style="width: 640px;" /></a>
<p class="caption"><span class="caption-number">図 7 </span><span class="caption-text">本項で構築するAWS環境（CloudFront）</span><a class="headerlink" href="#aws1-cloudfront" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id2">
<h3>用語<a class="headerlink" href="#id2" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="glossary simple">
<dt id="term-S3">S3</dt><dd><ul class="simple">
<li><p>安価で耐久性の高いAWSのクラウドストレージサービス</p></li>
<li><p>特徴</p>
<ul>
<li><p>1GB約3円/月</p></li>
<li><p>ほぼ100%の高い耐久性</p></li>
<li><p>容量無制限。1ファイル最大5TBまで</p></li>
<li><p>バケットやオブジェクトに対してアクセス制限を設定できる</p></li>
</ul>
</li>
<li><p>重要概念</p>
<ul>
<li><p>バケット</p>
<ul>
<li><p>オブジェクトの保存場所。名前はグローバルでユニークな必要あり</p></li>
</ul>
</li>
<li><p>オブジェクト</p>
<ul>
<li><p>データ本体。S3に格納されるファイルで、各々にURLが付与される</p></li>
<li><p>バケット内オブジェクト数は無制限</p></li>
</ul>
</li>
<li><p>キー</p>
<ul>
<li><p>オブジェクトの格納URLパス</p></li>
</ul>
</li>
</ul>
</li>
<li><p>利用シーン</p>
<ul>
<li><p>静的コンテンツの配信</p>
<ul>
<li><p>img画像をS3から配信</p></li>
</ul>
</li>
<li><p>バッチ連携用のファイル置き場</p>
<ul>
<li><p>S3にファイルを置いて、バッチでそのファイルを参照して処理する</p></li>
</ul>
</li>
<li><p>ログなどの出力先</p>
<ul>
<li><p>定期的にS3にログを送る</p></li>
</ul>
</li>
<li><p>静的ウェブホスティング</p>
<ul>
<li><p>静的なウェブサイトをS3から公開</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</dd>
<dt id="term-CloudFront">CloudFront</dt><dd><p>AWSにおける <a class="reference internal" href="#term-CDN"><span class="xref std std-term">CDN</span></a> のサービス</p>
</dd>
<dt id="term-CDN">CDN</dt><dd><ul class="simple">
<li><p>Content Delivery Network</p></li>
<li><p>高速にコンテンツを配信するサービス</p></li>
<li><p>オリジンサーバ（元となる画像を配信するサーバ。今回の場合はS3）上にあるコンテンツを、
世界中100箇所以上にあるエッジロケーションにコピーし、そこから配信を行う</p></li>
<li><p>高速：ユーザから最も近いエッジサーバから画像を配信する</p></li>
<li><p>効率的：エッジサーバでコンテンツのキャッシングを行うので、オリジンサーバに負荷をかけずに配信できる</p></li>
</ul>
</dd>
<dt id="term-Certificate-Manager">Certificate Manager</dt><dd><p>証明書を発行・管理するためのAWSのサービス</p>
</dd>
<dt id="term-SSL">SSLサーバ証明書</dt><dd><ul class="simple">
<li><p>Webサーバの持ち主が実在することを示す電子証明書</p></li>
<li><p>ブラウザとWebサーバ間で暗号化通信（https）をする時に必要</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="id3">
<h3>説明<a class="headerlink" href="#id3" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="section" id="id4">
<h4>インフラ設計における重要な観点<a class="headerlink" href="#id4" title="このヘッドラインへのパーマリンク">¶</a></h4>
<ul class="simple">
<li><p>可用性：サービスを継続的に利用できるか（一番重要）</p></li>
<li><p>性能・拡張性：システムの性能が十分で、将来的においても拡張しやすいか</p></li>
<li><p>運用・保守性：運用と保守がしやすいか</p></li>
<li><p>セキュリティ：情報が安全に守られているか</p></li>
<li><p>移行性：現行システムを他のシステムに移行しやすくなっているか</p></li>
</ul>
</div>
<div class="section" id="webs3">
<h4>画像保存場所をWebサーバではなくS3にする理由<a class="headerlink" href="#webs3" title="このヘッドラインへのパーマリンク">¶</a></h4>
<ul class="simple">
<li><p>Webサーバのストレージが画像で一杯になるのを防ぐ</p></li>
<li><p>HTMLへのアクセスと画像へのアクセスを分けることで負荷分散する</p></li>
<li><p>サーバの台数を増やしやすくする（画像の保存場所を分離することで、<a class="reference internal" href="#term-2"><span class="xref std std-term">スケールアウト</span></a> しやすくする）</p></li>
<li><p>コンテンツ配信サービス（ <a class="reference internal" href="#term-CloudFront"><span class="xref std std-term">CloudFront</span></a> ）から配信することで、画像配信を高速化できる</p></li>
</ul>
</div>
</div>
<div class="section" id="id5">
<h3>手順<a class="headerlink" href="#id5" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>AWS側の準備</p>
<ul class="simple">
<li><p>S3のバケット作成</p>
<ul>
<li><p>AWS -&gt; S3 -&gt; バケット -&gt; 「バケットを作成する」ボタンを押す</p>
<ul>
<li><p>バケット名：グローバルでユニークな名称（例：aws-and-infra-wp-XXX）</p></li>
<li><p>リージョン：アジアパシフィック（東京）</p></li>
<li><p>既存のバケットから設定をコピー：空</p></li>
</ul>
</li>
<li><p>「次へ」ボタンを押す</p>
<ul>
<li><p>バージョニング：チェックなし</p></li>
<li><p>サーバアクセスのログ記録：チェックなし（本番環境ではチェックした方がよい）</p></li>
<li><p>Tags：空</p></li>
<li><p>オブジェクトレベルのログ記録：チェックなし</p></li>
<li><p>デフォルト暗号化：チェックなし</p></li>
<li><p>CloudWatchリクエストメトリクス：チェックなし</p></li>
</ul>
</li>
<li><p>「次へ」ボタンを押す</p>
<ul>
<li><p>パブリックアクセスをすべてブロック：チェックなし
（バケットとオブジェクトを外部公開したくない場合はチェックするが、今回は画像配信なのでチェックなし）</p></li>
<li><p>システムのアクセス許可の管理：アクセス権限を付与する</p></li>
</ul>
</li>
<li><p>「次へ」ボタンを押す</p></li>
<li><p>「バケットを作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>S3の権限を持ったIAMユーザを作成</p>
<ul>
<li><p>AWS -&gt; IAM -&gt; ユーザー -&gt; 「ユーザーを追加」ボタンを押す</p>
<ul>
<li><p>ユーザ名：任意（例：aws-and-infra-wpadmin）</p></li>
<li><p>アクセスの種類：「プログラムによるアクセス」にチェック
（WordPressからS3にアクセスするため）</p></li>
</ul>
</li>
<li><p>「次のステップ」ボタンを押す</p>
<ul>
<li><p>「既存のポリシーを直接アタッチ」をクリック</p></li>
<li><p>ポリシーのフィルタに「S3」を入力</p></li>
<li><p>「AmazonS3FullAccess」にチェックを入れる</p></li>
</ul>
</li>
<li><p>「次のステップ」ボタンを押す</p>
<ul>
<li><p>タグの追加：空</p></li>
</ul>
</li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「ユーザーの作成」ボタンを押す</p></li>
<li><p>「.csvのダウンロード」ボタンを押し、ファイルを保存する（失くさないこと）
（WordPress から S3 にアクセスするために必要）</p></li>
<li><p>「閉じる」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>WordPressの設定</p>
<ul>
<li><p>プラグインのインストール</p>
<ul class="simple">
<li><p>WordPressの管理画面にログイン</p></li>
<li><p>プラグイン -&gt; 「新規追加」ボタンを押す</p></li>
<li><p>検索ボックスに「WP Offload Media」を入力し、WP Offload Mediaを今すぐインストール</p></li>
<li><p>「有効化」ボタンを押す</p></li>
</ul>
</li>
<li><p>必要なライブラリをEC2にインストール</p>
<ul>
<li><p>EC2にSSH接続し、インストール</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo yum install -y php-xml
<span class="gp">$</span> sudo yum install -y php-gd
</pre></div>
</div>
</li>
<li><p>インストールしたライブラリを読み込ますためにサーバを再起動させる</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo systemctl restart httpd.service
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>プラグインの設定</p>
<ul>
<li><p>WordPressの管理画面をリロード</p></li>
<li><p>設定 -&gt; Offload Media をクリックし、以下をコピーする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">define</span><span class="p">(</span> <span class="s1">&#39;AS3CF_SETTINGS&#39;</span><span class="p">,</span> <span class="n">serialize</span><span class="p">(</span> <span class="n">array</span><span class="p">(</span>
    <span class="s1">&#39;provider&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;aws&#39;</span><span class="p">,</span>
    <span class="s1">&#39;access-key-id&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;********************&#39;</span><span class="p">,</span>
    <span class="s1">&#39;secret-access-key&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;**************************************&#39;</span><span class="p">,</span>
<span class="p">)</span> <span class="p">)</span> <span class="p">);</span>
</pre></div>
</div>
</li>
<li><p>EC2へのSSH接続画面にて、</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /var/www/html/

<span class="gp">$</span> ls
<span class="go">index.php        wp-blog-header.php    wp-cron.php        wp-mail.php</span>
<span class="go">license.txt      wp-comments-post.php  wp-includes        wp-settings.php</span>
<span class="go">readme.html      wp-config.php         wp-links-opml.php  wp-signup.php</span>
<span class="go">wp-activate.php  wp-config-sample.php  wp-load.php        wp-trackback.php</span>
<span class="go">wp-admin         wp-content            wp-login.php       xmlrpc.php</span>

<span class="gp">$</span> vim wp-config.php
<span class="go">// 開いたファイルの最後の方のdefine(～);の最後に、上記でコピーした内容を貼り付ける</span>
<span class="go">// &#39;**・・&#39;の箇所は、S3の権限を持ったIAMユーザ作成時に保存したcsvファイルを開き、</span>
<span class="go">// Access key ID と Secret access key をコピーし貼り付ける</span>
</pre></div>
</div>
</li>
<li><p>Offload Media の画面に戻り、画面をリロード</p>
<ul class="simple">
<li><p>「Enter bucket name」をクリックし、事前に作成したバケットを選択する</p></li>
<li><p>「Save Selected Bucket」ボタンを押す</p></li>
</ul>
</li>
<li><p>設定確認画面にて</p>
<ul class="simple">
<li><p>最後の「Remove File From Server」をONに設定。
これで、画像がサーバに保存されずにS3にのみ保存される</p></li>
<li><p>「Save Changes」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>画像がS3に保存されることを確認</p>
<ul class="simple">
<li><p>WordPressで画像を投稿する</p>
<ul>
<li><p>WordPress管理画面 -&gt; 投稿 -&gt; 投稿一覧 -&gt; Hello world!（何でもよい） -&gt; 編集　をクリック</p></li>
<li><p>「画像の追加」ボタンを押し、画像をアップロードする</p></li>
<li><p>「更新」ボタンを押し、「投稿を表示」をクリック</p></li>
<li><p>アップロードした画像を右クリックし、メニューから「新しいタブで画像を開く」を選択</p></li>
<li><p>画像のURLがs3～となっていればOK</p></li>
</ul>
</li>
<li><p>S3のバケットを確認する</p>
<ul>
<li><p>AWS -&gt; S3 -&gt; バケット -&gt; aws-and-infra-wp-XXX（事前作成のバケット） をクリック</p></li>
<li><p>wp-content -&gt; uploads -&gt; ・・・に画像が保管されていることを確認</p></li>
</ul>
</li>
</ul>
</li>
<li><p>CloudFrontから配信する</p>
<ul class="simple">
<li><p>ディストリビューションの作成
（ディストリビューションとは、CloudFrontの配信ルールのこと）</p>
<ul>
<li><p>AWS -&gt; CloudFront -&gt; 「Create Distribution」ボタンを押す</p></li>
<li><p>Web -&gt; 「Get Started」ボタンを押す</p>
<ul>
<li><p>Origin Domain Name：オリジンサーバのS3名（例：aws-and-infra-wp-xxx.s3.amazonaws.com）</p></li>
<li><p>Origin Path：空欄（オリジンサーバの特定ディレクトリを指定する場合に使用）</p></li>
<li><p>Origin ID：デフォルト（例：S3-aws-and-infra-wp-xxx）</p></li>
<li><p>Restrict Bucket Access：No
（画像にアクセスする際に、S3のURLではなくCloudFrontからのみアクセスしたい場合にYesを選択）</p></li>
<li><p>Origin Custom HeadersHeader Name：空欄</p></li>
<li><p>Default Cache Behavior Settings：全てデフォルトでOK</p></li>
<li><p>Distribution Settings：全てデフォルトでOK
（Price Classが「Use All Edge Locations」となっていることのみ確認しておく）</p></li>
<li><p>「Create Distribution」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>ここまでの設定では、WordPressの画像にアクセスするとCloudFrontのドメインのURLとなる。
それでも特に問題はないが、画像のURLはそのWebページのドメインと同じであることが推奨されている。
以降では、画像URLを独自ドメインのURLとするための設定を行う</p></li>
</ul>
</li>
<li><p>独自ドメインから配信する</p>
<ul class="simple">
<li><p><a class="reference internal" href="#term-Certificate-Manager"><span class="xref std std-term">Certificate Manager</span></a> で <a class="reference internal" href="#term-SSL"><span class="xref std std-term">SSLサーバ証明書</span></a> の発行</p>
<ul>
<li><p>作成されたディストリビューションのIDをクリックし、「Edit」ボタンを押す</p></li>
<li><p>Alternate Domain Names(CNAMEs)：独自ドメインの先頭にサブドメインを付ける（例：staic.xxx.work）</p></li>
<li><p>「Request or Import a Certificate with ACM」ボタンを押す</p>
<ul>
<li><p>ドメイン名：*.独自ドメイン名（例：*.xxx.work）</p></li>
<li><p>「この証明書に別の名前を追加」ボタンを押す</p></li>
<li><p>入力可能となったテキストボックス（追加の名前）に独自ドメイン名を記入（例：xxx.work）
（追加の名前に独自ドメイン名を記載しないと、サブドメインに対する証明書しか発行されず、
独自ドメイン本体に対しては証明書が発行されないこととなる）</p></li>
<li><p>「次へ」ボタンを押す</p></li>
<li><p>検証方法の選択：「DNS の検証」を選択</p></li>
<li><p>「次へ」ボタンを押す</p></li>
<li><p>「確認」ボタンを押す</p></li>
<li><p>「確定とリクエスト」ボタンを押す</p></li>
<li><p>ドメイン左の▼をクリックし、表示された「Route53でのレコード作成」ボタンを押す</p>
<ul>
<li><p>「作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>もう一方のドメインについては不要（放置していたら「Route53でのレコード作成」ボタンが不活性化）</p></li>
<li><p>「続行」ボタンを押す</p></li>
<li><p>状況が「検証保留中」から「発行済み」に変わるまで待機する</p></li>
</ul>
</li>
</ul>
</li>
<li><p>CloudFrontのディストリビューションに独自ドメインを登録</p>
<ul>
<li><p>CloudFrontのディストリビューション画面をリロードする</p></li>
<li><p>作成されたディストリビューションのIDをクリックし、「Edit」ボタンを押す</p></li>
<li><p>Alternate Domain Names(CNAMEs)：独自ドメインの先頭にサブドメインを付ける（例：staic.xxx.work）</p></li>
<li><p>SSL Certificate：「Custom SSL Certificate」を選択し、「*.xxx.work」を選ぶ</p></li>
<li><p>「Yes, Edit」ボタンを押す</p></li>
</ul>
</li>
<li><p>Route53で独自ドメインとCloudFrontドメインのCNAMEレコード（CNAMEは別名の意）を作成する</p>
<ul>
<li><p>AWS -&gt; Route53 -&gt; ホストゾーン -&gt; xxx.work をクリック</p></li>
<li><p>「レコードセットの作成」ボタンを押す</p>
<ul>
<li><p>名前：static（上で設定した名称）</p></li>
<li><p>タイプ：CNAME</p></li>
<li><p>値：xxxxx.cloudfront.net（CloudFront での Domain Name をコピペで入力）</p></li>
<li><p>「作成」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Offload Media で独自ドメインを登録する</p>
<ul>
<li><p>WordPress管理画面にログイン -&gt; 設定 -&gt; Offload Media Lite をクリック</p>
<ul>
<li><p>Custom Domain (CNAME)：ONにして、「static.xxx.work」を入力</p></li>
<li><p>「Save Changes」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id6">
<h3>補足<a class="headerlink" href="#id6" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>S3のバケットに複数の画像が保管されるのを停止する</p>
<ul>
<li><p>WordPressのデフォルト設定では、1枚の画像をアップロードすると、勝手に複数サイズの画像が自動生成される。
これを停止するためには以下を設定する</p></li>
<li><p>WordPress管理画面 -&gt; 設定 -&gt; メディア で、全ての数値を0にして更新</p></li>
<li><p><a class="reference external" href="http://xxx/wp-admin/options.php">http://xxx/wp-admin/options.php</a> で「medium_large_size_w」を0にして更新</p></li>
<li><p>参考：<a class="reference external" href="https://tabi-z.com/wordpress-autoresize-stop">https://tabi-z.com/wordpress-autoresize-stop</a></p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="elbweb">
<h2>【ELB】Webレイヤを冗長化する<a class="headerlink" href="#elbweb" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id7">
<h3>本項で構築するAWS環境<a class="headerlink" href="#id7" title="このヘッドラインへのパーマリンク">¶</a></h3>
<div class="figure align-default" id="aws2-web">
<a class="reference internal image-reference" href="../../_images/AWS応用2_Webサーバの冗長化.png"><img alt="../../_images/AWS応用2_Webサーバの冗長化.png" src="../../_images/AWS応用2_Webサーバの冗長化.png" style="width: 640px;" /></a>
<p class="caption"><span class="caption-number">図 8 </span><span class="caption-text">本項で構築するAWS環境（Webサーバの冗長化）</span><a class="headerlink" href="#aws2-web" title="この画像へのパーマリンク">¶</a></p>
</div>
</div>
<div class="section" id="id8">
<h3>用語<a class="headerlink" href="#id8" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="glossary simple">
<dt id="term-0">プロビジョニング</dt><dd><p>アクセス数などを予測して適切にリソースを準備すること</p>
</dd>
<dt id="term-1">スケールアップ</dt><dd><ul class="simple">
<li><p>個々の要素の性能を向上させる</p></li>
<li><p>ある程度の規模まではスケールアップがコストパフォーマンスがよいが、
一定範囲を超えると悪くなる</p></li>
</ul>
</dd>
<dt id="term-2">スケールアウト</dt><dd><ul class="simple">
<li><p>個々の要素の数を増やす（サーバの台数を増やす）</p></li>
<li><p>ある程度の規模を超えそうであれば、スケールアウトで対応する</p></li>
<li><p>最低用意しておくべきがN+1構成、安心なのはN+2構成</p></li>
</ul>
</dd>
<dt id="term-ELB">ELB</dt><dd><ul class="simple">
<li><p>Elastic Load Balancing</p></li>
<li><p>AWS上の <a class="reference internal" href="#term-3"><span class="xref std std-term">ロードバランサー</span></a></p></li>
<li><p>機能</p>
<ul>
<li><p>複数のEC2インスタンスに負荷分散する</p></li>
<li><p>複数のアベイラリティゾーンにある複数のEC2インスタンスの中から正常なターゲットにのみ振り分ける（ヘルスチェック）</p></li>
</ul>
</li>
<li><p>特徴</p>
<ul>
<li><p>ELB自体もスケーラブル（負荷に応じ自動でスケールアウト／スケールイン）</p></li>
<li><p>アベイラリティゾーンをまたがる構成のため障害に強い</p></li>
<li><p>ELBへの接続ポイントへのアクセスにはDNSを使用する
（IPアドレスを用いると自動でスケールアウト／スケールインしないので要注意）</p></li>
<li><p>安価な従量課金</p></li>
<li><p>マネージドサービスで運用が楽</p></li>
</ul>
</li>
</ul>
</dd>
<dt id="term-3">ロードバランサー</dt><dd><p>各サーバにアクセスを振り分け、負荷を分散する装置</p>
</dd>
<dt id="term-4">ステートレス</dt><dd><p>システムが現在の状態を表すデータなどを保持せず、入力の内容によってのみ出力が決定される方式。
同じ入力に対する出力は常に同じになる。
Webサーバでは、データなどをWebサーバが保持せず、DBサーバやS3に一元管理することで、
Webサーバに冗長性を持たせても（Webサーバを複数台設置して負荷分散しても）必ず同じ応答にすることができる。</p>
</dd>
</dl>
</div>
<div class="section" id="id9">
<h3>稼働率を上げるための方法<a class="headerlink" href="#id9" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>稼働率を上げるための基本的な考え方</p>
<ul class="simple">
<li><p>障害発生間隔を長くする</p></li>
<li><p>平均復旧時間を短くする</p></li>
</ul>
</li>
<li><p>稼働率を上げるための手法</p>
<ul class="simple">
<li><p>冗長化。これにより単一障害点（SPOF：Single Point Of Failure）をなくす</p></li>
</ul>
</li>
<li><p>稼働率を上げるための具体的な方法（AWSを使う場合は2,3が対象）</p>
<ol class="arabic simple">
<li><p>要素単体の稼働率を高くする</p></li>
<li><p>要素を組み合わせて、全体の稼働率を高くする</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Active-Active</p></li>
<li><p>Active-Standby (Hot/Warm/Cold)</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple" start="3">
<li><p>負荷を適切な <a class="reference internal" href="#term-0"><span class="xref std std-term">プロビジョニング</span></a> で回避する</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="#term-1"><span class="xref std std-term">スケールアップ</span></a></p></li>
<li><p><a class="reference internal" href="#term-2"><span class="xref std std-term">スケールアウト</span></a></p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="id10">
<h3>サーバ構成のベストプラクティス<a class="headerlink" href="#id10" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ol class="arabic simple">
<li><p>Webサーバ x 1、DBサーバ x 1 構成</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>1台でサーバスペックが足りなくなったら、DBを別のサーバに切り出す</p></li>
<li><p>DBを外部公開しないよう設定できるのでセキュリティ面でも推奨</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple">
<li><p>Webサーバ x 2、DBサーバ x 1 構成</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Web側の性能が足りない時に、Webサーバを複数台使うことで、Webの冗長化と負荷分散を行う</p></li>
</ul>
</div></blockquote>
<ol class="arabic simple">
<li><p>Webサーバ x 2、DBサーバ x 2 構成</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>DBをマスタスレーブ方式にすることで、DBの冗長化を行う</p></li>
<li><p>スレーブDBにはマスタDBをレプリケーション（同期）し、マスタ障害時にスレーブに切り替える</p></li>
<li><p>AWSでは、「マスタスレーブ方式」のことを「マルチAZ」と呼ぶ</p></li>
</ul>
</div></blockquote>
</div>
<div class="section" id="elb">
<h3>ELBを運用する際のポイント<a class="headerlink" href="#elb" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>サーバをアベイラリティゾーンをまたがって配置する</p></li>
<li><p>Webサーバは <a class="reference internal" href="#term-4"><span class="xref std std-term">ステートレス</span></a> に構築する</p></li>
</ul>
</div>
<div class="section" id="id11">
<h3>手順<a class="headerlink" href="#id11" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>AMIからEC2を作成</p>
<ul>
<li><p>パブリックサブネットの作成</p>
<ul class="simple">
<li><p>AWS -&gt; VPC -&gt; サブネット -&gt; 「サブネットの作成」ボタンを押す</p>
<ul>
<li><p>名前タグ：aws-and-infra-public-subnet-1c</p></li>
<li><p>VPC：事前作成のVPCを選択</p></li>
<li><p>VPC CIDR：デフォルトのまま</p></li>
<li><p>アベイラリティゾーン：ap-northeast-1c</p></li>
<li><p>IPv4 CIDRブロック：任意のプライベートIPアドレス（10.0.11.0/24）</p></li>
<li><p>「作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>作成したサブネット -&gt; ルートテーブル -&gt; 「ルートテーブルの関連付けの編集」ボタンを押す</p>
<ul>
<li><p>ルートテーブルID：事前作成のテーブルを選択（例：aws-and-infra-public-route）</p></li>
<li><p>「保存」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>AMIの作成</p>
<ul class="simple">
<li><p>AWS -&gt; EC2 -&gt; インスタンス から事前作成のEC2を選択する</p></li>
<li><p>アクション -&gt; イメージ -&gt; イメージの作成　を選択する</p>
<ul>
<li><p>イメージ名：任意（例：aws-and-infra-web_XXX）</p></li>
<li><p>イメージの説明：任意（例：aws-and-infra-web_XXX）</p></li>
<li><p>「イメージの作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>AWS -&gt; EC2 -&gt; AMI　を選択し、作成したイメージがあることを確認
（ステータスが&quot;pending&quot;になっている）</p></li>
</ul>
</li>
<li><p>AMIからEC2を作成</p>
<ul class="simple">
<li><p>AWS -&gt; EC2 -&gt; AMI　を選択し、「起動」ボタンを押す</p>
<ul>
<li><p>インスタンスタイプ：t2.micro</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>インスタンス数：1</p></li>
<li><p>購入のオプション：チェックなし（常時インスタンスを起動したいためスポットインスタンスではない）</p></li>
<li><p>ネットワーク：事前作成のVPCを選択（例：aws-and-infra-vpc）</p></li>
<li><p>サブネット：事前作成のパブリックサブネットを選択（例：aws-and-infra-public-subnet-1c）</p></li>
<li><p>自動割り当てパブリックIP：有効（インターネット経由でアクセスしたいため）</p></li>
<li><p>配置グループ：チェックなし（複数インスタンスがある場合にインスタンス間のアクセスを高速化するために利用するもの）</p></li>
<li><p>キャパシティーの予約：なし（EC2インスタンスが必ず利用できるように予め予約するためのもの。追加料金が発生する）</p></li>
<li><p>ネットワークインターフェイス -&gt; プライマリIP：任意（例：10.0.11.10）</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「タグを追加」ボタンを押す</p>
<ul>
<li><p>キー：Name</p></li>
<li><p>値：aws-and-infra-web</p></li>
</ul>
</li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>セキュリティグループの割り当て：既存（例：aws-and-infra-web）</p></li>
<li><p>「確認と作成」ボタンを押す</p></li>
<li><p>「起動」ボタンを押す</p>
<ul>
<li><p>「既存のキーペアの選択」を選択し</p></li>
<li><p>キーペアの選択：事前作成のキーペア（例：aws-and-infra-ssh-key）</p></li>
<li><p>チェックボックスにチェック</p></li>
</ul>
</li>
<li><p>「インスタンスの作成」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>EC2インスタンスの説明を追加する</p>
<ul>
<li><p>EC2（10.0.10.10）へのSSH接続画面にて、</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> <span class="nb">cd</span> /var/www/html/

<span class="gp">$</span> ls
<span class="go">index.php        wp-blog-header.php    wp-cron.php        wp-mail.php</span>
<span class="go">license.txt      wp-comments-post.php  wp-includes        wp-settings.php</span>
<span class="go">readme.html      wp-config.php         wp-links-opml.php  wp-signup.php</span>
<span class="go">wp-activate.php  wp-config-sample.php  wp-load.php        wp-trackback.php</span>
<span class="go">wp-admin         wp-content            wp-login.php       xmlrpc.php</span>

<span class="gp">$</span> sudo vim index.php
<span class="go">// 開いたファイルの末尾に「echo &#39;&lt;p&gt;sample 1a&lt;/p&gt;&#39;;」を追加し上書き保存</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">注釈</p>
<p>index.php上書き保存時に「E45 readonly option is set(add ! to override)」
が表示されたら、vimのコマンドモードで「:w !sudo tee %」を実行し、「:q!」で終了させる</p>
</div>
</li>
<li><p>EC2（10.0.11.10）へのSSH接続画面にて、上記と同様に
index.phpファイル末尾に「echo '&lt;p&gt;sample 1a&lt;/p&gt;';」を追加し上書き保存する</p></li>
</ul>
</li>
</ul>
</li>
<li><p>ELBの作成</p>
<ul class="simple">
<li><p>ELBの作成</p>
<ul>
<li><p>AWS -&gt; EC2 -&gt; ロードバランサー -&gt; 「ロードバランサー」ボタンを押す</p></li>
<li><p>Application Load Balancer -&gt; 「作成」ボタンを押す</p>
<ul>
<li><p>名前：任意（例：aws-and-infra-alb）</p></li>
<li><p>スキーム：「インターネット向け」にチェック</p></li>
<li><p>IPアドレスタイプ：ipv4</p></li>
<li><p>リスナー：全てデフォルトでOK</p></li>
<li><p>VPC：事前作成のVPCを選択（例：aws-and-infra-vpc）</p></li>
<li><p>アベイラリティゾーン：各々のパブリックサブネットを選択</p></li>
<li><p>「次の手順」ボタンを押す</p></li>
<li><p>「次の手順」ボタンを押す</p></li>
<li><p>セキュリティグループの割り当て：「新しいセキュリティグループを作成する」にチェック</p>
<ul>
<li><p>セキュリティグループ名：任意（例：aws-and-infra-alb）</p></li>
<li><p>説明：任意（例：aws-and-infra-alb）</p></li>
<li><p>タイプ：HTTP</p></li>
</ul>
</li>
<li><p>「次の手順」ボタンを押す</p></li>
<li><p>ターゲットグループ</p>
<ul>
<li><p>ターゲットグループ：「新しいターゲットグループ」を選択</p></li>
<li><p>名前：任意（例：aws-and-infra-web-tg）</p></li>
<li><p>ターゲットの種類：インスタンス</p></li>
<li><p>プロトコル：HTTP</p></li>
<li><p>ポート：80</p></li>
</ul>
</li>
<li><p>ヘルスチェック</p>
<ul>
<li><p>プロトコル：HTTP</p></li>
<li><p>パス：/（必ず応答を返すパスを設定すること）</p></li>
</ul>
</li>
<li><p>ヘルスチェックの詳細設定</p>
<ul>
<li><p>正常のしきい値：2（デフォルト5から修正。後でヘルスチェック機能を確認したいため）</p></li>
<li><p>間隔：10（デフォルト30から修正。後でヘルスチェック機能を確認したいため）</p></li>
</ul>
</li>
<li><p>「次の手順」ボタンを押す</p></li>
<li><p>ターゲットの登録</p>
<ul>
<li><p>インスタンス：両インスタンスにチェック</p></li>
<li><p>「登録済みに追加」ボタンを押す</p></li>
</ul>
</li>
<li><p>「次の手順」ボタンを押す</p></li>
<li><p>「作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>作成したロードバランサーの状態が「provicioning」から「active」となるまで待機する</p></li>
</ul>
</li>
<li><p>ELBの動作を確認</p>
<ul>
<li><p>作成したロードバランサーを選択し、DNS名をコピーしブラウザでアクセスする</p></li>
<li><p>一番下に「sample 1a」が表示されることを確認する</p></li>
<li><p>画面を何度かリロードすると「sample 1c」が表示される</p></li>
</ul>
</li>
<li><p>独自ドメインからELBにアクセス</p>
<ul>
<li><p>AWS -&gt; Route53 -&gt; ホストゾーン -&gt; 既存のドメイン名「xxx.work」をクリック</p></li>
<li><p>Aレコードの独自ドメインを選択し編集する
（現時点では、EC2インスタンスのグローバルIPアドレスが設定されている）</p>
<ul>
<li><p>エイリアス：はい</p></li>
<li><p>エイリアス先：事前作成のロードバランサーを選択（例：aws-and-infra-alb）</p></li>
<li><p>「レコードセットの保存」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id12">
<h3>ELB動作確認<a class="headerlink" href="#id12" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>1aのEC2インスタンスが停止中の場合の動作を確認する</p></li>
<li><p>EC2（10.0.10.10）にSSH接続し、Apacheを停止させる</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo systemctl stop httpd.service
</pre></div>
</div>
</li>
<li><p>独自ドメイン「xxx.work」にアクセスする
→ 画面をリロードしても「sample 1c」のみが表示される</p></li>
<li><p>AWS -&gt; EC2 -&gt; ロードバランシング -&gt; ターゲットグループ -&gt; 事前作成のターゲットグループを選択 -&gt; 下のターゲットタブをクリック
→ 登録済みターゲットの1aがunhealthyに、1cがhealthyとなっている</p></li>
<li><p>EC2（10.0.10.10）にSSH接続し、Apacheを再開させる</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> sudo systemctl start httpd.service
</pre></div>
</div>
</li>
<li><p>独自ドメイン「xxx.work」にアクセスし画面をリロードすると「sample 1a/1c」が交互に表示される</p></li>
</ul>
</div>
<div class="section" id="id13">
<h3>後片付け（無料枠を超過しないよう元に戻す）<a class="headerlink" href="#id13" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>1cをロードバランサーのターゲットから外す</p>
<ul>
<li><p>AWC -&gt; EC2 -&gt; ロードバランシング -&gt; ターゲットグループ -&gt; ターゲット -&gt; 編集　より1cを選択して削除</p></li>
</ul>
</li>
<li><p>1cのEC2インスタンスを終了する</p>
<ul>
<li><p>AWC -&gt; EC2 -&gt; インスタンス -&gt; 1cインスタンス -&gt; アクション -&gt; インスタンスの状態 -&gt; 終了　をクリック</p></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="section" id="rdcdb">
<h2>【RDC】DBレイヤを冗長化する<a class="headerlink" href="#rdcdb" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id14">
<h3>説明<a class="headerlink" href="#id14" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>RDSでは、マルチAZ機能を使ってマスタスレーブ構成を構築する</p></li>
<li><p>マスタDBに障害が発生してスレープDBに切り替わった場合は、IPアドレスは変わるが、DBのエンドポイントは変わらない。
よって、特に何もしなくても使い続けることができる。</p></li>
</ul>
</div>
<div class="section" id="id15">
<h3>手順<a class="headerlink" href="#id15" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>AWS -&gt; RDS -&gt; データベース -&gt; 作成済みDB -&gt; 「変更」ボタンを押す</p>
<ul>
<li><p>マルチAZ配置：はい</p></li>
<li><p>「次へ」ボタンを押す</p></li>
<li><p>変更のスケジュール：すぐに適用</p></li>
<li><p>「DBインスタンスの変更」ボタンを押す</p></li>
</ul>
</li>
<li><p>概要 -&gt; 情報　が「変更中」から「利用可能」に変わるまで待機する
（結構時間がかかる）</p></li>
</ul>
</div>
<div class="section" id="id16">
<h3>後片付け（無料枠を超過しないよう元に戻す）<a class="headerlink" href="#id16" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>上記手順の逆手順でマルチAZ配置をOFFする</p>
</div>
</div>
<div class="section" id="cloudwatch">
<h2>【CloudWatch】システムを監視する<a class="headerlink" href="#cloudwatch" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id17">
<h3>用語<a class="headerlink" href="#id17" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="glossary simple">
<dt id="term-5">システム監視</dt><dd><ul class="simple">
<li><p>システムを正常な状態に保てるよう、稼働状況やリソースを監視すること</p></li>
<li><p>大別して、 <span class="xref std std-term">死活監視</span> と <a class="reference internal" href="#term-7"><span class="xref std std-term">メトリクス監視</span></a> の2種類がある</p></li>
</ul>
</dd>
<dt id="term-6">しかつかんし（死活監視）</dt><dd><ul class="simple">
<li><p>正常にシステムが動作していることを確認</p></li>
</ul>
</dd>
<dt id="term-7">メトリクス監視</dt><dd><ul class="simple">
<li><p>パフォーマンスを定量的に確認</p></li>
<li><p>指標を決め、指標が閾値以上・以下となっているかを把握</p></li>
</ul>
</dd>
<dt id="term-CloudWatch">CloudWatch</dt><dd><ul class="simple">
<li><p>AWSサービスの監視やモニタリングができる監視サービス</p></li>
<li><p>AWSサービスのメトリクス（リソース状況）を監視する</p></li>
<li><p>メトリクスに対して閾値を登録し、その条件を満たしたら通知する（アラーム発生）</p></li>
<li><p><a class="reference internal" href="#term-Amazon-SNS"><span class="xref std std-term">Amazon SNS</span></a> と組み合わせて使用する</p></li>
</ul>
</dd>
<dt id="term-Amazon-SNS">Amazon SNS</dt><dd><ul class="simple">
<li><p>通知サービス</p></li>
<li><p>Topicを作成することで、Publisherがメッセージを送信し、
Subscriberが通知を受信するための通信チャネルとして機能する</p></li>
<li><p>PublisherとSubscriberを疎結合とし、Publisherなどの変更時の対応を簡単にするためのもの</p></li>
</ul>
</dd>
</dl>
</div>
<div class="section" id="id18">
<h3>説明<a class="headerlink" href="#id18" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>監視する際のポイント</p>
<ul>
<li><p>項目が多すぎると監視疲れし正常に監視できなくなる可能性がある。
また、システムも利用状況が変わるので、都度調整が必要。</p></li>
<li><p>基本的には、CPU、Memory、Disk、Networkの使用率・枯渇を監視項目に設定すればよい</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id19">
<h3>手順<a class="headerlink" href="#id19" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>以降では、CPU使用率が60%を超えたら、
EC2 → CloudWatch → SNS → ユーザの経路にて、Eメールを送信する監視を構築する</p></li>
<li><p>CloudWatchのアラームを作成</p>
<ul class="simple">
<li><p>CloudWatchのアラームを作成</p>
<ul>
<li><p>AWS -&gt; CloudWatch -&gt; アラーム -&gt; 「アラームの作成」ボタンを押す</p>
<ul>
<li><p>メトリクスと条件の指定</p>
<ul>
<li><p>「メトリクスの選択」ボタンを押す</p></li>
<li><p>EC2 -&gt; インスタンス別メトリクス　をクリックする</p></li>
<li><p>CPUUtilizationをチェックし、「メトリクスの選択」ボタンを押す</p></li>
<li><p>期間：1分（デフォルト5分から変更。早く検知させるため）</p></li>
<li><p>CPUUtilizationが次の時：以上</p></li>
<li><p>よりも：60</p></li>
<li><p>「次へ」ボタンを押す</p></li>
</ul>
</li>
<li><p>アクションの設定</p>
<ul>
<li><p>SNSトピックの選択：新しいトピックの作成</p></li>
<li><p>トピック名：任意（例：cloudwatch_alarms_topic）</p></li>
<li><p>「トピックの作成」ボタンを押す</p></li>
<li><p>「次へ」ボタンを押す</p></li>
</ul>
</li>
<li><p>名前と説明を追加</p>
<ul>
<li><p>アラーム名：任意（例：aws-and-infra-ec2-cpu）</p></li>
<li><p>アラームの説明：任意（例：aws-and-infra-ec2-cpu）</p></li>
<li><p>「次へ」ボタンを押す</p></li>
</ul>
</li>
<li><p>「アラームの作成」ボタンを押す</p></li>
<li><p>通知先に指定したメアドにメールが届いているので、認証すること</p></li>
</ul>
</li>
</ul>
</li>
<li><p>SNSのトピックを確認</p>
<ul>
<li><p>AWS -&gt; SNS -&gt; トピック　をクリックすると、上で作成したトピック（cloudwatch_alarms_topic）が表示される</p></li>
<li><p>AWS -&gt; SNS -&gt; サブスクリプション　をクリックすると、購読者のメアドが登録されている</p></li>
<li><p>トピックにサブスクリプションを追加していくことで、各購読者に通知する</p></li>
</ul>
</li>
</ul>
</li>
<li><p>アラートを確認</p>
<ul>
<li><p>&quot;yes &gt; /dev/null &amp;&quot; コマンドをEC2上で実行</p>
<ul>
<li><p>EC2インスタンスにSSH接続する</p></li>
<li><p>EC2が高負荷となるようコマンドを実行する</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> yes &gt; /dev/null <span class="p">&amp;</span>
</pre></div>
</div>
</li>
<li><p>CPU使用率を確認</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$</span> top
<span class="go">PID USER      PR  NI    VIRT    RES    SHR S %CPU %MEM     TIME+ COMMAND</span>
<span class="go">4838 ec2-user  20   0  114632    740    676 R 18.9  0.1   0:19.70 yes</span>
<span class="go">4839 ec2-user  20   0  114632    740    676 R 18.9  0.1   0:19.47 yes</span>
<span class="go">4836 ec2-user  20   0  114632    748    684 R 18.6  0.1   0:24.07 yes</span>
<span class="go">4837 ec2-user  20   0  114632    772    708 R 18.6  0.1   0:20.17 yes</span>
<span class="go">4840 ec2-user  20   0  114632    720    656 R 18.6  0.1   0:19.35 yes</span>
<span class="go">3924 apache    20   0  485256  44284   9036 S  6.0  4.4   1:26.69 httpd</span>
<span class="go">    1 root      20   0  125560   5424   3968 S  0.0  0.5   0:02.64 systemd</span>
<span class="go">    2 root      20   0       0      0      0 S  0.0  0.0   0:00.00 kthreadd</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>アラートが来ることを確認</p>
<ul class="simple">
<li><p>AWS -&gt; CloudWatch -&gt; アラーム をクリックすると、アラーム状態となっており、メールを送信される</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id20">
<h3>後片付け（無料枠を超過しないよう元に戻す）<a class="headerlink" href="#id20" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>EC2インスタンスにSSH接続する</p></li>
<li><p>yesコマンドを解除する</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// yesコマンドのプロセスを表示する</span>
<span class="gp">$</span> ps aux <span class="p">|</span> grep yes
<span class="go">ec2-user  4836 19.7  0.0 114632   748 pts/0    R    12:47   1:50 yes</span>
<span class="go">ec2-user  4837 19.2  0.0 114632   772 pts/0    R    12:47   1:46 yes</span>
<span class="go">ec2-user  4838 19.1  0.0 114632   740 pts/0    R    12:47   1:45 yes</span>
<span class="go">ec2-user  4839 19.1  0.0 114632   740 pts/0    R    12:47   1:45 yes</span>
<span class="go">ec2-user  4840 19.1  0.0 114632   720 pts/0    R    12:47   1:45 yes</span>
<span class="go">ec2-user  4858  0.0  0.0 119416   988 pts/0    S+   12:57   0:00 grep --color=aut</span>

<span class="go">// yesコマンドのプロセスを停止する</span>
<span class="go">// 4836-4840：yesコマンドのプロセスID</span>
<span class="gp">$</span> <span class="nb">kill</span> -9 <span class="m">4836</span>
<span class="gp">$</span> <span class="nb">kill</span> -9 <span class="m">4837</span>
<span class="gp">$</span> <span class="nb">kill</span> -9 <span class="m">4838</span>
<span class="gp">$</span> <span class="nb">kill</span> -9 <span class="m">4839</span>
<span class="gp">$</span> <span class="nb">kill</span> -9 <span class="m">4840</span>
</pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="iam">
<h2>【IAM】アクセス権限を管理する<a class="headerlink" href="#iam" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="id21">
<h3>用語<a class="headerlink" href="#id21" title="このヘッドラインへのパーマリンク">¶</a></h3>
<dl class="glossary simple">
<dt id="term-IAM">IAM</dt><dd><ul class="simple">
<li><p>AWSのサービスを利用するユーザ権限を管理するサービス</p></li>
<li><p>AWSリソースをセキュアに操作するために、認証・認可の仕組みを提供する</p></li>
<li><p>各AWSリソースに対して別々のアクセス権限をユーザ毎に付与できる</p></li>
<li><p>AWS IAM自体の利用は無料</p></li>
</ul>
</dd>
<dt id="term-8">IAMポリシー</dt><dd><p>アクセス許可の定義。
「どのAWSサービスの」「どのリソースに対して」「どんな操作を」「許可する（許可しない）」を定義</p>
</dd>
<dt id="term-9">IAMユーザ</dt><dd><p>個々のアカウントのユーザ</p>
</dd>
<dt id="term-10">IAMグループ</dt><dd><p>IAMユーザの集合。
複数のユーザにアクセス許可を付与する作業を簡素化。
グループに対してポリシーを設定できる</p>
</dd>
<dt id="term-11">IAMロール</dt><dd><p>一時的にアクセスを許可したアカウントを発行できる。
EC2やLambdaなどのAWSリソースに権限を付与するために使用</p>
</dd>
</dl>
</div>
<div class="section" id="id22">
<h3>作業内容<a class="headerlink" href="#id22" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>作成するポリシー</p>
<ul>
<li><p>DeveloperPolicy</p>
<ul>
<li><p>EC2の全操作</p></li>
<li><p>RDSの全操作</p></li>
</ul>
</li>
<li><p>DirectorPolicy</p>
<ul>
<li><p>EC2の読み取り</p></li>
</ul>
</li>
</ul>
</li>
<li><p>作成するグループ</p>
<ul>
<li><p>Developers</p></li>
<li><p>Directors</p></li>
</ul>
</li>
<li><p>作成するユーザ</p>
<ul>
<li><p>kume（Developers）</p></li>
<li><p>taguchi（Developers）</p></li>
<li><p>fukushima（Directors）</p></li>
</ul>
</li>
<li><p>作成するロール</p>
<ul>
<li><p>Web（AmazonS3FullAccess）</p></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id23">
<h3>手順<a class="headerlink" href="#id23" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul>
<li><p>IAMポリシーを作成する</p>
<ul class="simple">
<li><p>AWS -&gt; IAM -&gt; ポリシー -&gt; 「ポリシーの作成」ボタンを押す</p></li>
<li><p>DeveloperPolicy</p>
<ul>
<li><p>サービス：EC2</p></li>
<li><p>アクション：すべてのEC2アクション　にチェック</p></li>
<li><p>リソース：すべてのリソース　にチェック</p></li>
<li><p>「さらにアクセス許可を追加する」をクリック</p></li>
<li><p>サービス：RDS</p></li>
<li><p>アクション：すべてのRDSアクション　にチェック</p></li>
<li><p>リソース：すべてのリソース　にチェック</p></li>
<li><p>「ポリシーの確認」ボタンを押す</p></li>
<li><p>名前：AwsAndInfraDeveloperPolicy</p></li>
<li><p>説明：AwsAndInfraDeveloperPolicy</p></li>
<li><p>「ポリシーの作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>DirectorPolicy</p>
<ul>
<li><p>サービス：EC2</p></li>
<li><p>アクション：読み込み　にチェック</p></li>
<li><p>リソース：すべてのリソース　にチェック</p></li>
<li><p>「ポリシーの確認」ボタンを押す</p></li>
<li><p>名前：AwsAndInfraDirectorPolicy</p></li>
<li><p>説明：AwsAndInfraDirectorPolicy</p></li>
<li><p>「ポリシーの作成」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>IAMグループを作成する</p>
<ul class="simple">
<li><p>AWS -&gt; IAM -&gt; グループ -&gt; 「新しいグループの作成」ボタンを押す</p></li>
<li><p>Developers</p>
<ul>
<li><p>グループ名：AwsAndInfraDevelopers</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>ポリシー：AwsAndInfraDeveloperPolicy　にチェック</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「グループの作成」ボタンを押す</p></li>
</ul>
</li>
<li><p>Directors</p>
<ul>
<li><p>グループ名：AwsAndInfraDirectors</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>ポリシー：AwsAndInfraDirectorPolicy　にチェック</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「グループの作成」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>IAMユーザを作成する</p>
<ul class="simple">
<li><p>AWS -&gt; IAM -&gt; ユーザ -&gt; 「ユーザを追加」ボタンを押す</p></li>
<li><p>Developers に所属するユーザ</p>
<ul>
<li><p>ユーザ名：kume</p></li>
<li><p>「別のユーザーの追加」をクリック</p></li>
<li><p>ユーザ名：taguchi</p></li>
<li><p>アクセスの種類：AWS マネジメントコンソールへのアクセス　にチェック</p></li>
<li><p>コンソールのパスワード：自動生成がよいが、今回はカスタムでpasswordとする</p></li>
<li><p>パスワードのリセットが必要：チェック入れる</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>アクセス許可の設定：ユーザーをグループに追加</p></li>
<li><p>グループ名：AwsAndInfraDevelopers　にチェック</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「ユーザーの作成」ボタンを押す</p></li>
<li><p>「.csvのダウンロード」ボタンを押してファイルに保存する</p></li>
<li><p>「閉じる」ボタンを押す</p></li>
</ul>
</li>
<li><p>Directors に所属するユーザ</p>
<ul>
<li><p>ユーザ名：fukushima</p></li>
<li><p>アクセスの種類：AWS マネジメントコンソールへのアクセス　にチェック</p></li>
<li><p>コンソールのパスワード：自動生成がよいが、今回はカスタムでpasswordとする</p></li>
<li><p>パスワードのリセットが必要：チェック入れる</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>アクセス許可の設定：ユーザーをグループに追加</p></li>
<li><p>グループ名：AwsAndInfraDirectors　にチェック</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「ユーザーの作成」ボタンを押す</p></li>
<li><p>「.csvのダウンロード」ボタンを押してファイルに保存する</p></li>
<li><p>「閉じる」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>IAMロールを作成する前に、EC2からS3バケットリストを出力する</p>
<ul>
<li><p>EC2へのSSH接続画面にて、</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// S3バケットリストの出力コマンドを実行すると、</span>
<span class="go">// エラーメッセージが出力される</span>
<span class="gp">$</span> aws s3 ls
<span class="go">Unable to locate credentials.</span>
<span class="go">You can configure credentials by running &quot;aws configure&quot;.</span>
</pre></div>
</div>
</li>
</ul>
</li>
<li><p>IAMロールを作成する</p>
<ul class="simple">
<li><p>AWS -&gt; IAM -&gt; ロール -&gt; 「ロールの作成」ボタンを押す</p>
<ul>
<li><p>信頼されたエンティティの種類を選択：AWSサービス</p></li>
<li><p>ユースケースの選択：EC2</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>ポリシー：AmazonS3FullAccess</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>「次のステップ」ボタンを押す</p></li>
<li><p>ロール名：AwsAndInfraWeb</p></li>
<li><p>「ロールの作成」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>EC2インスタンスに作成したロールを割り当てる</p>
<ul class="simple">
<li><p>AWS -&gt; EC2 -&gt; インスタンス -&gt; aws-and-infra-web　にチェック</p></li>
<li><p>アクション -&gt; インスタンスの設定 -&gt; IAMロールの割り当て／置換　をクリック</p>
<ul>
<li><p>IAM ロール：事前作成のロール（例：AwsAndInfraWeb）</p></li>
<li><p>「適用」ボタンを押す</p></li>
<li><p>「閉じる」ボタンを押す</p></li>
</ul>
</li>
</ul>
</li>
<li><p>IAMロールを作成した後に、EC2からS3バケットリストを出力する</p>
<ul>
<li><p>EC2へのSSH接続画面にて、</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="go">// S3バケットリストの出力コマンドを実行する</span>
<span class="gp">$</span> aws s3 ls
<span class="go">2020-02-27 13:48:33 aws-and-infra-wp-tak</span>
</pre></div>
</div>
</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="id24">
<h3>補足<a class="headerlink" href="#id24" title="このヘッドラインへのパーマリンク">¶</a></h3>
<ul class="simple">
<li><p>IAMのベストプラクティス</p>
<ul>
<li><p>個々人にIAMユーザを作成する（ユーザ毎に操作履歴が記録される）</p></li>
<li><p>ユーザをグループに所属させ、グループに権限を割り当てる</p></li>
<li><p>権限は最小限にする</p></li>
<li><p>EC2インスタンスから実行するアプリケーションには、ロールを使用する
（EC2インスタンスからAWSの別のサービスにアクセスする場合はロールを使用する）</p></li>
<li><p>定期的に不要な認証情報を削除する（退職者のユーザなど）</p></li>
</ul>
</li>
</ul>
</div>
</div>
</div>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">目次</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../sphinx/index.html">Sphinx</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../GitHub/index.html">GitHub</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../VirtualBox/index.html">VirtualBox</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../Linux/index.html">Linux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../raspberry_pi/index.html">Raspberry Pi</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Webアプリ</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../%E7%94%A8%E8%AA%9E.html">用語</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">AWS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../HTML.html">HTML</a></li>
<li class="toctree-l2"><a class="reference internal" href="../CSS.html">CSS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Bootstrap.html">Bootstrap</a></li>
<li class="toctree-l2"><a class="reference internal" href="../JavaScript.html">JavaScript</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Flask/index.html">Flask</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Ruby.html">Ruby</a></li>
<li class="toctree-l2"><a class="reference internal" href="../MySQL.html">MySQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../Ruby%20on%20Rails.html">Ruby on Rails</a></li>
<li class="toctree-l2"><a class="reference internal" href="../%E5%85%B1%E9%80%9A%E3%81%AE%E3%83%A1%E3%83%A2.html">共通のメモ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../C%EF%BC%83/index.html">C＃</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3/index.html">デザインパターン</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E5%82%99%E5%BF%98%E9%8C%B2/index.html">備忘録</a></li>
</ul>

  <h3><a href="../../index.html">目次</a></h3>
  <ul>
<li><a class="reference internal" href="#">AWS応用</a><ul>
<li><a class="reference internal" href="#s3-cloudfront">【S3/CloudFront】画像を配信する</a><ul>
<li><a class="reference internal" href="#id1">本項で構築するAWS環境</a></li>
<li><a class="reference internal" href="#id2">用語</a></li>
<li><a class="reference internal" href="#id3">説明</a><ul>
<li><a class="reference internal" href="#id4">インフラ設計における重要な観点</a></li>
<li><a class="reference internal" href="#webs3">画像保存場所をWebサーバではなくS3にする理由</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id5">手順</a></li>
<li><a class="reference internal" href="#id6">補足</a></li>
</ul>
</li>
<li><a class="reference internal" href="#elbweb">【ELB】Webレイヤを冗長化する</a><ul>
<li><a class="reference internal" href="#id7">本項で構築するAWS環境</a></li>
<li><a class="reference internal" href="#id8">用語</a></li>
<li><a class="reference internal" href="#id9">稼働率を上げるための方法</a></li>
<li><a class="reference internal" href="#id10">サーバ構成のベストプラクティス</a></li>
<li><a class="reference internal" href="#elb">ELBを運用する際のポイント</a></li>
<li><a class="reference internal" href="#id11">手順</a></li>
<li><a class="reference internal" href="#id12">ELB動作確認</a></li>
<li><a class="reference internal" href="#id13">後片付け（無料枠を超過しないよう元に戻す）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#rdcdb">【RDC】DBレイヤを冗長化する</a><ul>
<li><a class="reference internal" href="#id14">説明</a></li>
<li><a class="reference internal" href="#id15">手順</a></li>
<li><a class="reference internal" href="#id16">後片付け（無料枠を超過しないよう元に戻す）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cloudwatch">【CloudWatch】システムを監視する</a><ul>
<li><a class="reference internal" href="#id17">用語</a></li>
<li><a class="reference internal" href="#id18">説明</a></li>
<li><a class="reference internal" href="#id19">手順</a></li>
<li><a class="reference internal" href="#id20">後片付け（無料枠を超過しないよう元に戻す）</a></li>
</ul>
</li>
<li><a class="reference internal" href="#iam">【IAM】アクセス権限を管理する</a><ul>
<li><a class="reference internal" href="#id21">用語</a></li>
<li><a class="reference internal" href="#id22">作業内容</a></li>
<li><a class="reference internal" href="#id23">手順</a></li>
<li><a class="reference internal" href="#id24">補足</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>前のトピックへ</h4>
  <p class="topless"><a href="AWS%E5%9F%BA%E7%A4%8E.html"
                        title="前の章へ">AWS基礎</a></p>
  <h4>次のトピックへ</h4>
  <p class="topless"><a href="Cloud9.html"
                        title="次の章へ">Cloud9</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">クイック検索</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="検索" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>ナビゲーション</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="総合索引"
             >索引</a></li>
        <li class="right" >
          <a href="Cloud9.html" title="Cloud9"
             >次へ</a> |</li>
        <li class="right" >
          <a href="AWS%E5%9F%BA%E7%A4%8E.html" title="AWS基礎"
             >前へ</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Tak Documents  ドキュメント</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Webアプリ</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >AWS</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">AWS応用</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, tak.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 3.2.1.
    </div>
  </body>
</html>